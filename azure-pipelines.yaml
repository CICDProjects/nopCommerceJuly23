---

trigger:
  - workshop-develop


stages:
  - stage: buildstage
    displayName: Build flea commerce
    pool:
      vmImage: ubuntu-22.04
    jobs:
      - job: buildJob
        displayName: Build and Publish
        steps:
          - task: DotNetCoreCLI@2
            inputs:
              command: build
              projects: src/NopCommerce.sln
          - task: CopyFiles@2
            inputs:
              contents: 'src/Presentation/Nop.Web/bin/Debug/net7.0/**'
              targetFolder: $(Build.ArtifactStagingDirectory)
          - task: PublishBuildArtifacts@1
            inputs:
              pathToPublish: $(Build.ArtifactStagingDirectory)
              artifactName: nopreleaseartifacts
  # artifacts src/Presentation/Nop.Web/bin/Debug/net7.0
  - stage: deploy
    displayName: Deploy flea commerce
    pool: Default
    jobs:
      - job: deployJob
        displayName: Terraform Deploy Job
        steps:
          - task: DownloadBuildArtifacts@1
            inputs:
              buildType: 'current'
              artifactName: nopreleaseartifacts
              downloadPath: /tmp
          - bash: terraform init
            displayName: Initialize Terraform
            workingDirectory: vmdeploy
          - bash: terraform apply -auto-approve
            displayName: Deploy Terraform
            workingDirectory: vmdeploy
          - bash: "ansible-playbook -i $(terraform output -raw nop_url) --key-file '/home/ubuntu/foransible_new.pem' nopdeploy.yaml"
            displayName: Provision using ansible
            workingDirectory: vmdeploy 
